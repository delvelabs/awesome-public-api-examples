from datetime import date, timedelta
from enum import Enum
import json
import os
import requests


class Precision(Enum):
    day = "Day"
    week = "Week"
    month = "Month"


ACCESS_TOKEN = os.getenv("ACCESS_TOKEN", "")
API_BASE_URL = os.getenv("API_BASE_URL", "")

TEAM_ID = 1
TAG_ID = 12
START_DATE = date.today() - timedelta(days=30)
END_DATE = date.today()
PRECISION = Precision.day.value

headers = {
        "authorization": f"Bearer {ACCESS_TOKEN}",
    "accept": "application/json",
    "accept-language": "fr"
}
query = {
    "bool": {
        "must": [
            {"team": {"id": f"{TEAM_ID}"}},
            {"tag": {"id": f"{TAG_ID}"}},
        ],
        "should": [
            {"first_discovery_date": {"gte": START_DATE.isoformat()}},
            {"last_seen_date": {"lte":  END_DATE.isoformat()}},
        ]
    }
}
params = dict(q=json.dumps(query), limit=0, offset=0)
response = requests.get(f"{API_BASE_URL}/vulnerability-groups/distribution",
                        params=params,
                        headers=headers,
                        verify=False)
response.raise_for_status()

series = dict(
    first=response.json().get(f"firstDiscoveryDate{PRECISION}").get("series"),
    last=response.json().get(f"lastSeenDate{PRECISION}").get("series"),
)
values = dict(
    first=next(x.get("data") for x in series.get("first") if x.get("label") == "count"),
    last=next(x.get("data") for x in series.get("last") if x.get("label") == "count")
)
vulnerability_variation = sum(values["first"]) - sum(values["last"])

print(f"Current Vulnerability Variation: {vulnerability_variation}")
